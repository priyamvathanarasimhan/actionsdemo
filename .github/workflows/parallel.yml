name: Chrome headless
on: [push]
jobs:
  cypress-run:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'

      - name: Set env variables
        uses: ./packages/cache/__tests__/__fixtures__/

      - name: Install root npm packages
        run: npm ci

      - name: Compile cache package
        run: |
          npm ci
          npm run tsc
        working-directory: packages/cache

      - name: Generate files in working directory
        shell: bash
        run: packages/cache/__tests__/create-cache-files.sh ${{ runner.os }} test-cache

      - name: Generate files outside working directory
        shell: bash
        run: packages/cache/__tests__/create-cache-files.sh ${{ runner.os }} ~/test-cache

      # We're using node -e to call the functions directly available in the @actions/cache package
      - name: Save cache using saveCache()
        run: |
          node -e "Promise.resolve(require('./packages/cache/lib/cache').saveCache(['test-cache','~/test-cache'],'test-${{ runner.os }}-${{ github.run_id }}'))"
      - name: Delete cache folders before restoring
        shell: bash
        run: |
          rm -rf test-cache
          rm -rf ~/test-cache
      - name: Restore cache using restoreCache() with http-client
        run: |
          node -e "Promise.resolve(require('./packages/cache/lib/cache').restoreCache(['test-cache','~/test-cache'],'test-${{ runner.os }}-${{ github.run_id }}',[],{useAzureSdk: false}))"
      - name: Verify cache restored with http-client
        shell: bash
        run: |
          packages/cache/__tests__/verify-cache-files.sh ${{ runner.os }} test-cache
          packages/cache/__tests__/verify-cache-files.sh ${{ runner.os }} ~/test-cache
      - name: Delete cache folders before restoring
        shell: bash
        run: |
          rm -rf test-cache
          rm -rf ~/test-cache
      - name: Restore cache using restoreCache() with Azure SDK
        run: |
          node -e "Promise.resolve(require('./packages/cache/lib/cache').restoreCache(['test-cache','~/test-cache'],'test-${{ runner.os }}-${{ github.run_id }}'))"
      - name: Verify cache restored with Azure SDK
        shell: bash
        run: |
          packages/cache/__tests__/verify-cache-files.sh ${{ runner.os }} test-cache
          packages/cache/__tests__/verify-cache-files.sh ${{ runner.os }} ~/test-cache
      - run: npm install

      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          start: npm start
          spec: cypress/integration/*/*.spec.js
          browser: chrome
